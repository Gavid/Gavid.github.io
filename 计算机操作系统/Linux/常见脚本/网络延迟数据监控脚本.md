## 网络延迟数据监控脚本

### 脚本文件列表

```bash
script/
├── log
│   ├── analyzer_net_check_log.sh
├── log_clean.sh
├── log_collect.sh
├── net_check_tool.sh
├── ping.sh
├── route.ips
└── sink.ips
```

### Crontab 任务设置

```bash
# Network Monitoring
0 0 * * * bash /opt/baijiahao/script/net_check_tool.sh "out$(date +"\%Y\%m\%d\%H\%M\%S")" ping >> /opt/baijiahao/script/log/console.out
0 0 * * * bash /opt/baijiahao/script/net_check_tool.sh "out$(date -d "3 days ago" +"\%Y\%m\%d\%H\%M\%S")" clean >> /opt/baijiahao/script/log/console.out
0 0 * * * find /opt/baijiahao/script/log \( -name "clean_out*" -o -name "ping_out*" \) -type f -mtime +3 -exec sh -c 'cat /dev/null > "{}" && rm "{}"' \;
```

### 脚本内容

* analyzer_net_check_log.sh

  ```bash
  #!/bin/bash
  
  if [[ $# < 2 ]]; then
      #statements
      echo "input error, eg: bash $0 [collect_log_file_name] [time_number]";
      exit;
  fi
  
  scriptName="analyzer_net_check_log.sh";
  dir="/opt/baijiahao/script/log/"
  
  
  if [[ $scriptName =~ $dir  ]]; then
      :
  else
      scriptName="$dir"$scriptName;
  fi
  
  collect_log_file_name=$1;
  
  
  if [[ $collect_log_file_name =~ $dir  ]]; then
      :
  else
      collect_log_file_name="$dir"$collect_log_file_name;
  fi
  
  printf '%s\n' "$(grep "time=" $collect_log_file_name | awk -v param="$2" -F'[= ms]+' '$13>param {print}')"
  ```

* net_check_tool.sh

  ```bash
  #!/bin/bash
  
  if [[ $# < 2 ]]; then
      #statements
      echo "input error, eg: bash $0 test ping|collect|clean";
      exit;
  fi
  
  scriptName="net_check_tool.sh";
  host_ip=`hostname -i`;
  logTime=$(date +%Y%m%d_%H_%M_%S)
  #logFile="test_${logTime}.log"
  dir="/opt/baijiahao/script/"
  mkdir -p "$dir"log;
  logFile="${dir}log/$2_$1_${logTime}.log"
  
  route_ips_path=$dir"route.ips";
  sink_ips_path=$dir"sink.ips";
  console_out=$dir"console.out";
  
  if [[ $scriptName =~ $dir  ]]; then
      :
  else
      scriptName="$dir"$scriptName;
  fi
  # 登陆到下沉机器执行相关操作
  function route_ping() {
      for i in `cat $route_ips_path`; do
  	echo ------------------------------------------;
          echo $i"ping";
          if [[ $i == $host_ip ]]; then
              bash -s < "$dir"ping.sh $1 `cat $sink_ips_path` $i;
          else
              ssh -o StrictHostKeyChecking=no -T $i bash -s < "$dir"ping.sh $1 `cat $sink_ips_path` $i;
          fi
      done
  }
  
  function route_clean() {
      for i in `cat $route_ips_path`; do
          echo ------------------------------------------;
          echo $i"clean";
          if [[ $i == $host_ip ]]; then
              bash -s < "$dir"log_clean.sh $1 `cat $sink_ips_path`;
          else
              ssh -o StrictHostKeyChecking=no -T $i bash -s < "$dir"log_clean.sh $1 `cat $sink_ips_path`;
          fi
      done
  }
  
  function route_collect() {
      for i in `cat $route_ips_path`; do
          echo ------------------------------------------;
          echo $i"collect";
  
          if [[ $i == $host_ip ]]; then
              bash -s < "$dir"log_collect.sh $1 `cat $sink_ips_path`;
          else
              ssh -o StrictHostKeyChecking=no -T $i bash -s < "$dir"log_collect.sh $1 `cat $sink_ips_path`;
          fi
      done
  }
  
  function exec_main(){
      case $2 in
          "ping" )
          route_ping "$@"
          ;;
          "clean" )
          route_clean "$@"
          ;;
          "collect" )
          route_collect "$@"
          ;;
          * ) echo "input error, eg: bash $0 test ping|collect|clean"
          ;;
      esac
      sleep 1;
  }
  
  ### start invoke ###
  echo "$@" | grep -q -- "--nohup" && exec_main "$@" || echo "$@" | grep -q -- "--nohup" || nohup $scriptName "$@" --nohup >> ${logFile} 2>&1 &
  ```

* log_clean.sh

  ```bash
  #!/bin/bash
  
  # 执行日志删除操作
  log_clean() {
      for j in `echo $2 | tr ',' '\n'`; do
          >/opt/net_monitor_log/$j-$1.log;
          sleep 1;
          rm -rf /opt/net_monitor_log/$j-$1.log;
      done
  }
  
  log_clean "$@";
  ```

* log_collect.sh

  ```bash
  #!/bin/bash
  
  function log_collect() {
      for j in `echo $2 | tr ',' '\n'`; do
          cat /opt/net_monitor_log/$j-$1.log;
      done
  }
  
  log_collect "$@";
  ```

* ping.sh

  ```bash
  #!/bin/bash
  
  function ping() {
      for j in `echo $2 | tr ',' '\n'`; do
          mkdir -p /opt/net_monitor_log/;
          nohup ping -c 86400 $j | awk -v param="$3" '{ print $0"\t" strftime("%Y-%m-%d - %H:%M:%S",systime()) "\t" param ;fflush() }' >> /opt/net_monitor_log/$j-$1.log &
      done
  }
  
  ping "$@";
  ```

* route.ips （使用换行符进行分割）

  ```bash
  10.136.xx.xx
  10.136.xx.xx
  ```

* sink.ips （使用 ‘,’ 进行分割）

  ```bash
  10.136.xx.xx,10.186.xx.xx
  ```

